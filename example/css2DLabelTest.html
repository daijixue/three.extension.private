<!DOCTYPE html>
<html lang="en">
<head>
    <title>TJH  ar.js</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
    <style>
        body {
            background:#000;
            color:#fff;
            padding:0;
            margin:0;
            font-weight: bold;
            overflow:hidden;
        }

        #c{
            width:100vw;
            height:100vh;
            display: block;
        }

        .label{
            color: #ffffff;
            font-family: sans-serif;
            font-size: 15px;
            padding: 5px;
            background: rgba( 1, 1, 0, .6 );
        }
        #info {
            position: absolute;
            top: 0px; width: 100%;
            color: #ffffff;
            padding: 5px;
            font-family: Monospace;
            font-size: 13px;
            text-align: center;
            z-index:100;
        }

        a { color:red }

    </style>
</head>

<body>
<div id="container"></div>

<script src="../build/three.js"></script>
<script src="../build/three.extension.js"></script>
<script src="../build/tjh.ar.js"></script>
<script src="../build/extension/css2DLabelLayer.js"></script>
<script src="../build/tjh.ar.tools.js"></script>
<script src="../node_modules/three/examples/js/Detector.js"></script>
<script src="../build/extension/CSS2DRenderer.js"></script>
<script src="../node_modules/three/examples/js/libs/stats.min.js"></script>
<script src="../node_modules/jquery/dist/jquery.min.js"></script>
<script>

    if ( ! Detector.webgl ) Detector.addGetWebGLMessage();

    var container, stats;

    var camera, scene, renderer, labelRenderer;


    var controls, clock = new THREE.Clock();

    var labelLayer = null;

    var viewer = new tjh.ar.Viewer();

    // 最后渲染div Label
    viewer.onEndFrame = ()=> {
        if(useLabelRender) {
            labelRenderer.render(scene, camera);
            // labelRenderer.domElement.style.zIndex = -1;
        }
        stats.update();
    }

    var textureLoader = new THREE.TextureLoader();

    var labels = new THREE.Group();

    var selectTool = null, raycaster;
    var newtool = null;
    var useLabelRender = false;


    class SelctEvent extends tjh.ar.WindowEventListener {
        constructor(viewer, tl) {
            super(viewer);
            this.selObj = null;
            //

            this.onRightDown = (mouseEvent)=>
            {
                const clientX = mouseEvent.offsetX;
                const clientY = mouseEvent.offsetY;
                //
                let mouse = new THREE.Vector2();
                mouse.x = ( clientX / viewer.domElement.width ) * 2 - 1;
                mouse.y = - ( clientY / viewer.domElement.height ) * 2 + 1;
                //
                raycaster.setFromCamera( mouse, camera);
                raycaster.linePrecision = 3;
                let intersects = raycaster.intersectObjects([tl]);
                //
                if(intersects.length === 0) {
                    this.selObj = null;
                    return false;
                }
                //
                let selectObj = intersects[0].object;
                while (selectObj && !selectObj.isPlantModel && !selectObj.isFeature) {
                    if(selectObj.parent && selectObj.parent.name === "IndexNode")
                        break;
                    //
                    selectObj = selectObj.parent;
                }
                this.selObj = selectObj;
                this.selObj.visible = false;
                return selectObj;
            }


        }
    }

    class SelectEvent extends tjh.ar.WindowEventListener {
        constructor(viewer, tl) {
            super(viewer);
            //
            // labelDiv.style.marginTop = '-1em';
            this.onLeftDown = (mouseEvent)=> {
                const clientX = mouseEvent.offsetX;
                const clientY = mouseEvent.offsetY;

                raycaster = new THREE.Raycaster();
                //
                let mouse = new THREE.Vector2();
                mouse.x = ( clientX / viewer.domElement.clientWidth ) * 2 - 1;
                mouse.y = - ( clientY / viewer.domElement.clientHeight ) * 2 + 1;
                //
                raycaster.setFromCamera( mouse, viewer.camera);
                let intersects = raycaster.intersectObject( viewer.scene.terrainLayers[0],true);
                //
                if (intersects.length === 0)
                    return false;

                labelLayer.addLabel(labelLayer.children.length, "label:" + labelLayer.children.length, intersects[0].point);
            }
        }
    }

    class kySelect extends tjh.ar.WindowEventListener {
        constructor(viewer, tl) {
            super(viewer);
            //
            this.onKeyDown = (keyboardEvent)=> {
                if((keyboardEvent.keyCode === 115 || keyboardEvent.keyCode === 83)) {
                    if (!selectTool) {
                        selectTool = new SelectEvent(viewer, tl);
                        viewer.pushEventListenerFront(selectTool);
                        return true;
                    }
                    else {
                        viewer.removeEventListenerFront();
                        selectTool = null;
                        return true;
                    }
                }
                if((keyboardEvent.keyCode === 68)) {
                    if(!useLabelRender)
                    {
                        viewer.removeEventListenerFront();
                        selectTool = null;

                        useLabelRender = true;

                        //
                        let warpperDiv = document.createElement( 'div' );

                        labelRenderer = new THREE.CSS2DRenderer(viewer);
                        labelRenderer.setSize( window.innerWidth, window.innerHeight );

                        labelRenderer.domElement.style.position = 'absolute';
                        labelRenderer.domElement.style.top = 0;
                        labelRenderer.domElement.style.left = 0;

                        // document.body.appendChild( labelRenderer.domElement );
                        container.appendChild( labelRenderer.domElement );

                        newtool = new SelctEvent(viewer, labelLayer);
                        viewer.pushEventListenerFront(newtool);
                    }
                    else
                        useLabelRender = false;

                }
            }
            this.onRightDown = (mouseEvent)=> {

                //if(labelLayer.children.length > 0) {
                    //labelLayer.removeLabel(labelLayer.children[labelLayer.children.length -1 ]);
                //}
            }
        }
    }


    init();
    viewer.setBeginFrameCallBack(function () {
        //controls.update();
    })
    viewer.run();

    function init() {

        container = document.getElementById( 'container' );
        document.body.appendChild( container );

        renderer = new THREE.WebGLRenderer();
        renderer.setPixelRatio( window.devicePixelRatio );
        renderer.setSize( window.innerWidth, window.innerHeight );
        // renderer.domElement.style.zIndex = 2;
        container.appendChild( renderer.domElement );
        viewer.setRenderer(renderer);
        //
        camera = new THREE.PerspectiveCamera( 45, window.innerWidth / window.innerHeight, 1, 1500000 );
        viewer.setCamera(camera);
        //

        camera.position.set(530771-1274.28,2508554-425.81,2000);
        camera.lookAt(new THREE.Vector3(530771-1274.28,2508554-425.81, 52));

        scene = new tjh.ar.ARScene();
        scene.fog = new THREE.Fog( 0x000000, 1, 15000 );
        scene.autoUpdate = false;
        viewer.setScene(scene);

        controls = new tjh.ar.BasicTerrainControls(viewer);
        viewer.pushEventListenerFront(controls);

        var ambientLight = new THREE.AmbientLight( 0xffffff );
        scene.addLightSource( ambientLight );

        var light = new THREE.DirectionalLight( 0xffffff );
        light.position.set( 1, 1, 1 ).normalize();
        //scene.addLightSource( light );

        var terrainLayer = new tjh.ar.TerrainLayer();
        terrainLayer.forceRootLoad = true;
        terrainLayer.dataBasePager.maxWaitingLoaded = 3;
        terrainLayer.dataBasePager.maxSortRequests = 30;
        terrainLayer.dataBasePager.pageScaleFunc = function (contex, node) {
            const v1 = new THREE.Vector3();
            const v2 = new THREE.Vector3();
            v1.setFromMatrixPosition( contex.camera.matrixWorld );
            v2.setFromMatrixPosition( node.matrixWorld );
            let disToCamera = v1.distanceTo( v2 );
            if(disToCamera > 1500) {
                return 1500.0/disToCamera;
            }
            //
            return 1.0
        };


        //5
        terrainLayer.addTerrain("http://192.168.10.13:8002/api/data/osgjsData?urlInfo=753a7f62-d48e-44c9-97f8-8cd698f5cdfc");

        /*var pagedLod0 = new THREE.PagedLod();
        pagedLod0.addLevel("root.osgjs", 0, 100000);
        pagedLod0.setRangeMode(THREE.LOD.RangeMode.PIXEL_SIZE_ON_SCREEN);
        pagedLod0.boundingSphere = new THREE.Sphere(new THREE.Vector3(-618, 510, 31.14), 522);
        scene.add( pagedLod0 );*/
        scene.addTerrainLayer(terrainLayer);

        labelLayer = new CSS2DLabelLayer();

        scene.addCustomLayer(labelLayer);


        let defaultRenderTechnique = new tjh.ar.OutLineTechnique(renderer, scene, camera);
        viewer.pushRenderTechnique(defaultRenderTechnique);
        //
        //
        viewer.pushEventListenerFront(new kySelect(viewer, terrainLayer));
        //
        stats = new Stats();
        container.appendChild( stats.dom );
    }
</script>

</body>
</html>
